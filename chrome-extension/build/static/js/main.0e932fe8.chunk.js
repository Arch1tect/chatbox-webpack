(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{188:function(e,t,a){e.exports=a(399)},193:function(e,t,a){},214:function(e,t,a){},215:function(e,t,a){},241:function(e,t){},297:function(e,t,a){},318:function(e,t,a){},319:function(e,t,a){},320:function(e,t,a){},323:function(e,t,a){},332:function(e,t,a){},391:function(e,t,a){},392:function(e,t,a){},393:function(e,t,a){},394:function(e,t,a){},395:function(e,t,a){},396:function(e,t,a){},397:function(e,t,a){},399:function(e,t,a){"use strict";a.r(t);var n=a(0),o=a.n(n),r=a(7),c=a.n(r),s=(a(193),a(18)),l=a(19),i=a(21),u=a(20),m=a(22),d=a(12),f=a.n(d),p=a(37),g=a.n(p),b=a(407),h=a(14),v=a(9),E=(a(213),a(214),a(124)),y=a(405),w=(a(215),a(96)),O=a(406),j=a(171),k={cloudFront:"https://dnsofx4sf31ab.cloudfront.net/",debugMsgSrc:"http://localhost:9009",socketAPI:"https://api.yiyechat.com",dbAPI:"https://api-v2.yiyechat.com"},S=window.location.search.substring(1),C=function(){return S},x=function(){var e=function(e){var t;t=e.indexOf("//")>-1?e.split("/")[2]:e.split("/")[0];return t=(t=t.split(":")[0]).split("?")[0]}(C()),t=e.split("."),a=t.length;return a>2&&(e=t[a-2]+"."+t[a-1],2===t[a-2].length&&2===t[a-1].length&&(e=t[a-3]+"."+e)),e};var N=null,I=function(){return N},T=null,A={account:null,roomId:x()};var M={sendMessage:function(e){T.emit("new message",e)},updatePageInfo:function(e){T.emit("page update",e)},connect:function(e){if(A.account=e,T)return console.debug("socket already created, reconnect"),void(T.connected?console.warn("socket currently connected"):T.connect());console.debug("create socket and connect!"),(T=j(k.socketAPI,{path:"/socket.io"})).on("new message",function(e){console.debug(e),e.self=e.sender.toString()===A.account.id.toString(),e.type="text",e.message.startsWith("stickers/")&&(e.type="sticker"),e.content=e.message,e.userId=e.sender,e.name=e.username,e.hasAvatar&&(e.avatarSrc=k.cloudFront+e.userId+".jpg"),function(e){var t={msg:e};window.parent.postMessage(t,"*")}(e),P.onLiveMsg?P.onLiveMsg(e):console.warn("onLiveMsg not defined")}),T.on("user joined",function(e){P.onUserJoin?P.onUserJoin(e):console.warn("onUserJoin not defined")}),T.on("user left",function(e){P.onUserLeft?P.onUserLeft(e):console.warn("onUserLeft not defined")}),T.on("disconnect",function(e){console.debug("disconnect"),P.onDisconnected?P.onDisconnected(e):console.warn("onDisconnected not defined")}),T.on("login",function(e){console.debug("connected, login as "+A.account.id),P.onConnected?P.onConnected(e):console.warn("onConnected not defined"),T.emit("login",{username:A.account.name,userId:A.account.id,roomId:A.roomId,url:C(),version:"4.0.1",lang:"en",pageTitle:I(),token:A.account.token})})},togglePageSite:function(e){A.roomId=e,P.onRoomChange?P.onRoomChange(e):console.warn("onRoomChange not defined"),T.disconnect(),setTimeout(function(){T.connect()},500)},disconnect:function(){T?T.connected?(console.debug("disconnect socket"),T.disconnect()):console.warn("socket not connected, no need to disconnect"):console.warn("socket not created, cannot disconnect")}},P={},z=M,L=a(400),R=o.a.createContext(),B={background:"white",position:"fixed",zIndex:1,left:0,width:"100%",overflow:"auto",maxHeight:"50%",padding:5,paddingTop:10,borderBottom:"1px solid lightgray"};var F=function(e){var t=Object(n.useContext)(R),a=(e.users||[]).map(function(e){return e.user&&e.user.numId?e.avatarSrc=e.user.avatarSrc:e.hasAvatar&&(e.avatarSrc=k.cloudFront+e.userId+".jpg"),o.a.createElement("div",{className:"sp-online-user",onClick:function(){return t.selectOtherUser(e)},key:e.userId},o.a.createElement(L.a,{title:e.username,size:45,shape:"square",icon:"user",src:e.avatarSrc}),o.a.createElement("div",{className:"sp-online-user-username"},e.username))});return o.a.createElement("div",{style:B},a)},U=o.a.createContext();var D=function(e){var t=Object(n.useState)(!1),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useState)(x()),l=Object(v.a)(s,2),i=l[0],u=l[1],m=Object(n.useState)([]),d=Object(v.a)(m,2),f=d[0],p=d[1],g=Object(n.useContext)(U),b=Object(n.useContext)(R);Object(n.useEffect)(function(){return console.log("register user join/left handlers"),P.onUserJoin=function(e){p(e.onlineUsers)},P.onUserLeft=function(e){p(e.onlineUsers)},P.onRoomChange=function(e){u(e)},window.addEventListener("message",function(e){e.origin===k.debugMsgSrc&&p(e.data)},!1),function(){P.onUserJoin=null,P.onUserLeft=null}},[]);var h=o.a.createElement("center",null,o.a.createElement(w.a,{onClick:function(){b.changeTab("account")},size:"small",type:"primary"},"\u53bb\u767b\u5f55"));return g.account&&(h=o.a.createElement("div",null,o.a.createElement(O.a.Group,{className:"sp-toggle-page-site-chat",size:"small",value:i,buttonStyle:"solid",onChange:function(e){var t=e.target.value;z.togglePageSite(t)}},o.a.createElement(y.a,{placement:"bottom",title:"anywhere"},o.a.createElement(O.a.Button,{value:"lobby"},"\u5927\u5385")),o.a.createElement(y.a,{placement:"bottom",title:x()},o.a.createElement(O.a.Button,{value:x()},"\u7f51\u7ad9")),o.a.createElement(y.a,{placement:"bottom",title:C()},o.a.createElement(O.a.Button,{value:C()},"\u7f51\u9875"))),o.a.createElement(w.a,{style:{border:"none",position:"absolute",right:0},onClick:function(){return c(!r)},size:"small",icon:"team"},o.a.createElement("span",{style:{marginLeft:5}},f.length)),r&&o.a.createElement(F,{users:f}))),o.a.createElement("center",{className:"sp-tab-header"},h)},_=a(50);a(297);var W=function(e){var t=e.data,a=t.content,n="sp-message-body "+t.type;if("sticker"===t.type){var r=a;window.chrome&&window.chrome.extension&&(r=window.chrome.extension.getURL("build/"+a)),a=o.a.createElement("img",{alt:r,src:r})}return o.a.createElement("div",{className:n},a)},H=a(408),V=H.a.Meta,J={display:"inline-block",width:"100%",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",textAlign:"left",marginBottom:5};function q(e){return o.a.createElement("span",null,o.a.createElement(L.a,{size:48,src:e.src,icon:"user"}))}var G=function(e){var t=e.user,a=e.following,n=e.followerCount,r=e.followUser,c=e.directMessage,s=o.a.createElement("div",null,t.about&&o.a.createElement("div",{style:J},t.about),a&&o.a.createElement(w.a,{icon:"user-delete",size:"small",onClick:function(e){e.stopPropagation(),r(!1)}},"\u53d6\u6d88\u5173\u6ce8"),!a&&o.a.createElement(w.a,{icon:"user-add",type:"primary",size:"small",onClick:function(e){e.stopPropagation(),r(!0)}},"\u5173\u6ce8"),o.a.createElement(w.a,{onClick:function(e){e.stopPropagation(),c(t)},icon:"mail",style:{marginLeft:10},size:"small"},"\u79c1\u4fe1")),l=o.a.createElement(q,{followerCount:n,src:t.avatarSrc});return o.a.createElement(H.a,{onClick:function(e){e.stopPropagation()},size:"small",style:{width:270,overflow:"hidden"}},o.a.createElement(V,{avatar:l,title:t.name,description:s}))},K=a(71),X=function(e){return f.a.get("".concat(k.dbAPI,"/api/v1/user/").concat(e))},Y=function(){return f.a.get("".concat(k.dbAPI,"/api/v1/latest_users"))},$=function(e){var t=new FormData;return t.append("name",e.name),t.append("about",e.about),t.append("avatar",e.avatar,"avatar"),f.a.post(k.dbAPI+"/api/v1/user",t)},Q={follow:function(){console.log("follow not mounted")}},Z=function(e){var t={id:e};return f.a.post("".concat(k.dbAPI,"/api/v1/follow"),t)};var ee=function(e){var t=Object(n.useContext)(U),a=Object(n.useContext)(R),r=Object(n.useState)(e.user),c=Object(v.a)(r,2),s=c[0],l=c[1],i=Object(n.useState)(""),u=Object(v.a)(i,2),m=u[0],d=u[1],f=Object(n.useState)(!1),p=Object(v.a)(f,2),g=p[0],b=p[1],h=Object(n.useState)(!1),E=Object(v.a)(h,2),y=E[0],w=E[1],O=Object(n.useState)(!1),j=Object(v.a)(O,2),k=j[0],S=j[1],C=Boolean(e.wait);function x(e){b(e),d(e?m+1:m-1),Z(s.id).then(function(a){!function(e){var a=Object(K.a)({},t.account);e?a.followingCount++:a.followingCount--,t.setAccount(a)}(e),Q.follow(e,s)}).catch(function(e){console.error(e)}).then(function(){})}Object(n.useEffect)(function(){C||k||(w(!0),X(s.id).then(function(e){console.debug(e.data);var t=e.data;S(!0),l(t),b(t.following),d(t.followerCount)}).catch(function(e){console.error(e)}).then(function(){console.log("done loading"),w(!1)}))},[C,k]);var N=o.a.Children.map(e.children,function(e){return o.a.cloneElement(e,Object(K.a)({},e.props,{loading:y,loaded:k,user:s,followerCount:m,following:g,followUser:x,directMessage:a.directMessage}))});return o.a.createElement("span",null,N)},te=a(180),ae=a.n(te);function ne(e){var t="user",a=e.src;return e.loading&&e.showingCard&&(a=null,t="loading"),o.a.createElement(L.a,{icon:t,className:e.className,src:a,size:e.size,onClick:e.onClick,onMouseEnter:e.onMouseEnter,onMouseLeave:e.onMouseLeave})}function oe(e){var t="hidden";return e.loaded&&(t="visible"),o.a.createElement(ae.a,{style:{zIndex:10,visibility:t},onMouseEnter:function(t){e.showCard()},onMouseLeave:e.hideCard,anchorEl:e.anchorEl,open:e.showingCard},o.a.createElement(G,e))}var re=function(e){var t=e.user,a=Object(n.useContext)(R),r=Object(n.useState)(null),c=Object(v.a)(r,2),s=c[0],l=c[1],i=Boolean(s),u=0;function m(){clearTimeout(u),u=setTimeout(function(){l(null)},100)}function d(e){clearTimeout(u),e&&l(e)}return o.a.createElement("span",null,o.a.createElement(ee,{wait:!i,user:t},o.a.createElement(ne,{icon:"user",className:e.className,src:t.avatarSrc,size:e.size,onClick:function(){return a.selectOtherUser(t)},onMouseEnter:function(e){console.log("mouse enter avatar"),d(e.currentTarget)},onMouseLeave:m,showingCard:i}),o.a.createElement(oe,{showCard:d,hideCard:m,showingCard:i,anchorEl:s})))},ce={fontSize:"smaller",verticalAlign:"middle",marginLeft:5,marginRight:5};var se=function(e){var t=e.data,a={id:t.userId,name:t.name,self:t.self,avatarSrc:t.avatarSrc},n=null,r="left",c=o.a.createElement(L.a,{size:"small",icon:"user",src:a.avatarSrc});return!a.self&&e.withHoverCard&&(c=o.a.createElement(re,{className:"sp-chat-message-avatar",size:"small",user:a})),a.self?(r="right",n=o.a.createElement("div",{style:{marginTop:10}},o.a.createElement("span",{style:ce},a.name),c)):n=o.a.createElement("div",{style:{marginTop:10}},c,o.a.createElement("span",{style:ce},a.name)),e.mergeAbove&&(n=o.a.createElement("span",null)),o.a.createElement("div",{className:a.self?"self":"other",style:{textAlign:r}},n,o.a.createElement(W,{data:t}))},le={height:"calc(100% - 107px)",overflowY:"auto",overflowX:"hidden",width:"100%",position:"fixed",background:"#f6f9fc",padding:10,paddingBottom:50},ie=200,ue=function(e){function t(e){var a;return Object(s.a)(this,t),(a=Object(i.a)(this,Object(u.a)(t).call(this,e))).scrollToBottomIfNearBottom=function(e){e=e||100;var t=a.bodyRef.current;t.scrollHeight-t.scrollTop-t.offsetHeight<ie&&setTimeout(function(){t.scrollTop=t.scrollHeight},e)},a.addMsg=function(e){a.setState(function(t,a){return{messages:[].concat(Object(_.a)(t.messages),[e])}})},a.state={messages:e.data||[]},a.bodyRef=o.a.createRef(),window.addLiveMsgToChatBody=a.addMsg,a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"componentDidMount",value:function(){var e=this;console.log("register new message handler"),P.onLiveMsg=function(t){e.setState(function(e,a){return{messages:[].concat(Object(_.a)(e.messages),[t])}});var a=10;"sticker"===t.type&&(a=500),e.scrollToBottomIfNearBottom(a)}}},{key:"render",value:function(){var e=[],t=null,a=0;return this.state.messages.forEach(function(n){var r=!1;t&&t.userId===n.userId&&(r=!0),e.push(o.a.createElement(se,{withHoverCard:!0,key:a++,data:n,mergeAbove:r})),t=n}),o.a.createElement("div",{ref:this.bodyRef,style:le},e)}}]),t}(o.a.Component);ue.contextType=U;for(var me=ue,de=(a(318),a(319),a(404)),fe=(a(320),a(321),a(185)),pe=a(36),ge=function(e){function t(e){var a;return Object(s.a)(this,t),(a=Object(i.a)(this,Object(u.a)(t).call(this,e))).setWrapperRef=a.setWrapperRef.bind(Object(pe.a)(Object(pe.a)(a))),a.handleClickOutside=a.handleClickOutside.bind(Object(pe.a)(Object(pe.a)(a))),a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"componentDidMount",value:function(){document.addEventListener("mousedown",this.handleClickOutside)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("mousedown",this.handleClickOutside)}},{key:"setWrapperRef",value:function(e){this.wrapperRef=e}},{key:"handleClickOutside",value:function(e){e.target.className&&e.target.className.indexOf&&e.target.className.indexOf(this.props.exceptionClass)>-1||this.wrapperRef&&!this.wrapperRef.contains(e.target)&&(this.props.close(),e.isOutsideClick=!0)}},{key:"render",value:function(){return o.a.createElement("div",{ref:this.setWrapperRef},this.props.children)}}]),t}(o.a.Component),be={search:"\u641c\u7d22",clear:"\u6e05\u9664",notfound:"\u6ca1\u627e\u5230",skintext:"Choose your default skin tone",categories:{search:"\u641c\u7d22\u7ed3\u679c",recent:"\u5e38\u7528",people:"\u7b11\u8138",nature:"\u52a8\u690d\u7269",foods:"\u5403\u559d",activity:"\u6d3b\u52a8",places:"\u65c5\u6e38",objects:"\u4e1c\u897f",symbols:"\u8c61\u5f81",flags:"\u65d7\u5b50",custom:"\u6b22\u4e50\u5154"},categorieslabel:"Emoji categories",skintones:{1:"Default Skin Tone",2:"Light Skin Tone",3:"Medium-Light Skin Tone",4:"Medium Skin Tone",5:"Medium-Dark Skin Tone",6:"Dark Skin Tone"}},he=[],ve=1;ve<=90;ve++){var Ee="stickers/happy_bun/".concat(ve,".gif");he.push({name:"happy bun "+ve,short_names:["happy_bun_"+ve],imageUrl:Ee})}var ye=function(e){return o.a.createElement(ge,{exceptionClass:e.exceptionClass,close:e.close},o.a.createElement(fe.a,{i18n:be,emojiTooltip:!0,include:["custom","people","nature","foods","activity","places"],custom:he,onSelect:e.addEmoji,set:"apple",showPreview:!1}))};var we=function(e){var t=Object(n.useState)(""),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useRef)(),l=Object(n.useState)(!1),i=Object(v.a)(l,2),u=i[0],m=i[1],d=Object(n.useState)(!1),f=Object(v.a)(d,2),p=f[0],g=f[1],b=e.sending;Object(n.useEffect)(function(){b||s.current.focus()},[b]),Object(n.useEffect)(function(){m(p)},[p]);var E=o.a.createElement(h.a,{className:"emojiOpener",onClick:function(e){g(function(e){g(!e)})},type:"smile"});return o.a.createElement("div",{className:"sp-input-with-picker"},p&&o.a.createElement(h.a,{style:{margin:10},type:"loading"}),u&&o.a.createElement(ye,{addEmoji:function(t){t.custom?(e.send(t.imageUrl),g(!1)):c(function(e){return e+t.native}),s.current.focus()},exceptionClass:"emojiOpener",close:function(){g(!1)}}),o.a.createElement(de.a,{ref:s,size:"large",onKeyDown:function(t){"Enter"===t.key&&(g(!1),e.send(r)&&c(""))},value:r,addonBefore:E,onChange:function(e){c(e.target.value)},disabled:b,placeholder:b?"\u53d1\u9001\u4e2d\u3002\u3002\u3002":"\u8bf7\u8f93\u5165\u3002\u3002\u3002"}))},Oe=3e3,je=0;var ke=function(e){var t=Object(n.useContext)(U).account,a=o.a.createElement("center",{style:{padding:10,background:"lightgray"}},"\u5c1a\u672a\u767b\u5f55");return t&&(a=o.a.createElement(we,{send:function(e){var a=new Date;if(a-je>Oe){var n={msg:e,username:t.username};return z.sendMessage(n),je=a,!0}return b.a.warn("\u8bf7\u653e\u6162\u901f\u5ea6"),!1}})),o.a.createElement("div",{className:"sp-chat-bottom"},a)};var Se=function(e){return o.a.createElement("div",null,o.a.createElement(D,null),o.a.createElement(me,null),o.a.createElement(ke,null))},Ce=(a(323),a(402)),xe=Ce.a.Option;var Ne=function(e){return o.a.createElement("center",{className:"sp-tab-header"},o.a.createElement(Ce.a,{onChange:e.orderBy,size:"small",defaultValue:"best"},o.a.createElement(xe,{value:"newest"},"\u6309\u65f6\u95f4\u6392\u5e8f"),o.a.createElement(xe,{value:"best"},"\u6309\u597d\u8bc4\u6392\u5e8f")))};a(332);var Ie=function(e){var t=e.data,a={id:t.userId,name:t.name,avatarSrc:t.avatarSrc,self:t.self},r=Object(n.useState)(t.score),c=Object(v.a)(r,2),s=c[0],l=c[1],i=Object(n.useState)(t.voted),u=Object(v.a)(i,2),m=u[0],d=u[1],f=Object(n.useContext)(U).account;return o.a.createElement("div",{style:{marginTop:10},className:t.self?"self":""},o.a.createElement(re,{className:"sp-comment-message-avatar",user:a}),o.a.createElement("div",{className:"sp-message-body text"},o.a.createElement("div",{style:{marginBottom:5}},o.a.createElement("span",{className:"sp-comment-message-username"},t.name),o.a.createElement("span",{className:"sp-comment-message-time"},t.time)),o.a.createElement("div",null,t.content),!t.noFooter&&o.a.createElement("div",{className:"sp-comment-message-footer"},o.a.createElement("span",null,o.a.createElement(h.a,{theme:m?"twoTone":"outlined",onClick:function(){f&&(l(function(e){return m?e-1:e+1}),d(function(e){return!e}),e.vote(t.id))},type:"like"}),o.a.createElement("span",{className:"sp-comment-message-score"},s)),o.a.createElement("span",{onClick:function(){return e.reply(t.userId,t.name)},className:"sp-comment-message-reply"},"\u56de\u590d"))))};var Te=function(e){var t=(e.data||[]).map(function(t){return o.a.createElement(Ie,{vote:e.vote,reply:e.reply,key:t.id,data:t})});return t.length||(t=o.a.createElement("center",null,"\u6ca1\u6709\u8bc4\u8bba")),o.a.createElement("div",null,t)},Ae=10,Me={height:"calc(100% - 100px)",overflow:"auto",width:"100%",position:"fixed",background:"#eceff1",padding:10,paddingBottom:30},Pe=de.a.TextArea,ze=function(e){function t(e){var a;return Object(s.a)(this,t),(a=Object(i.a)(this,Object(u.a)(t).call(this,e))).onFocus=function(e){a.setState({inputFocus:!0})},a.reply=function(e,t){a.setState({replyTo:t,replyToUserId:e}),a.inputRef.current.focus()},a.vote=function(e){var t={comment_id:e};f.a.post(k.dbAPI+"/api/v1/vote_comment",t).then(function(e){}).catch(function(e){}).then(function(){})},a.submit=function(){var e={url:C(),content:a.state.input,reply_to_user_id:a.state.replyToUserId,reply_to_user_name:a.state.replyTo};a.setState({submitting:!0}),f.a.post(k.dbAPI+"/api/v1/post_comment",e).then(function(e){var t=a.state.input;a.state.replyTo&&(t="@"+a.state.replyTo+" \n"+t);var n=a.context.account,o={id:Math.random(100),userId:n.id,avatarSrc:n.avatarSrc,name:n.name,time:g()().fromNow(),content:t,self:!0,noFooter:!0};a.setState({comments:[o].concat(a.state.comments)}),a.clearInput(),setTimeout(function(){console.debug("[Comment] scroll to top"),a.bodyRef.current.scrollTop=0},500)}).catch(function(e){console.error(e)}).then(function(){a.setState({submitting:!1})})},a.handleInput=function(e){a.setState({input:e.target.value})},a.clearInput=function(){a.setState({input:"",inputFocus:!1,replyTo:null,replyToUserId:null})},a.orderBy=function(e){a.setState({comments:[]}),a.offset=0,a.order=e,a.loadComments()},a.loadMore=function(){a.offset=a.state.comments.length,a.loadComments()},a.loadComments=function(){a.setState({loading:!0});var e={url:C(),offset:a.offset,limit:Ae,order:a.order};f.a.post(k.dbAPI+"/api/v1/get_comments",e).then(function(e){e.data.forEach(function(e){e.time=g.a.utc(e.created).fromNow()}),a.setState({comments:a.state.comments.concat(e.data)})}).catch(function(e){console.error(e)}).then(function(){a.setState({loading:!1})})},a.state={loading:!1,submitting:!1,comments:[],input:"",inputFocus:!1,replyTo:"",replyToUserId:""},a.inputRef=o.a.createRef(),a.bodyRef=o.a.createRef(),a.offset=0,a.order="best",a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"componentDidMount",value:function(){this.loadComments()}},{key:"render",value:function(){var e=1;this.state.inputFocus&&(e=5);var t="\u7559\u8a00\u3002\u3002\u3002";this.state.replyTo&&(t="@"+this.state.replyTo);var a=o.a.createElement("center",{style:{padding:10,background:"lightgray"}},"\u5c1a\u672a\u767b\u5f55");return this.context.account&&(a=o.a.createElement("div",null,o.a.createElement(Pe,{size:"large",value:this.state.input,onFocus:this.onFocus,onChange:this.handleInput,placeholder:t,rows:e,ref:this.inputRef}),this.state.inputFocus&&o.a.createElement("div",{style:{width:"100%",textAlign:"right"}},o.a.createElement(w.a,{onClick:this.clearInput},"\u53d6\u6d88"),o.a.createElement(w.a,{onClick:this.submit,style:{margin:10},type:"primary",loading:this.state.submitting},"\u63d0\u4ea4")))),o.a.createElement("div",null,o.a.createElement(Ne,{orderBy:this.orderBy}),o.a.createElement("div",{ref:this.bodyRef,style:Me},this.state.loading&&0===this.state.comments.length&&o.a.createElement("center",null,o.a.createElement(h.a,{type:"loading"})),(!this.state.loading||this.state.comments.length>0)&&o.a.createElement(Te,{data:this.state.comments,vote:this.vote,reply:this.reply}),this.state.comments.length>0&&o.a.createElement("center",{style:{marginTop:20}},o.a.createElement(w.a,{loading:this.state.loading,type:"primary",onClick:this.loadMore},"\u52a0\u8f7d\u66f4\u591a..."))),o.a.createElement("div",{className:"sp-comment-footer"},a))}}]),t}(o.a.Component);ze.contextType=U;var Le=ze,Re=a(401),Be=function(){return f.a.get("".concat(k.dbAPI,"/api/v1/account"))},Fe=function(e,t){var a={userId:e,password:t};return f.a.post(k.dbAPI+"/api/v1/login",a)},Ue=function(){return f.a.post(k.dbAPI+"/api/v1/logout")},De=function(e){var t={password:e};return f.a.post(k.dbAPI+"/api/v1/reset_password",t)},_e=function(e){function t(){var e,a;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(a=Object(i.a)(this,(e=Object(u.a)(t)).call.apply(e,[this].concat(o)))).state={confirmDirty:!1},a.handleSubmit=function(e){e.preventDefault(),a.props.form.validateFieldsAndScroll(function(e,t){e||(De(t.password).then(function(){b.a.success("\u66f4\u6539\u6210\u529f\uff01")}).catch().then(),console.log("Received values of form: ",t))})},a.handleConfirmBlur=function(e){var t=e.target.value;a.setState({confirmDirty:a.state.confirmDirty||!!t})},a.compareToFirstPassword=function(e,t,n){var o=a.props.form;t&&t!==o.getFieldValue("password")?n("\u4e24\u6b21\u8f93\u5165\u4e0d\u4e00\u81f4!"):n()},a.validateToNextPassword=function(e,t,n){var o=a.props.form;t&&a.state.confirmDirty&&o.validateFields(["confirm"],{force:!0}),n()},a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this.props.form.getFieldDecorator;return o.a.createElement("div",{className:"sp-special-tab"},o.a.createElement(w.a,{onClick:this.props.back,style:{position:"fixed",marginTop:5,marginLeft:5,border:"none",fontSize:"large"},icon:"arrow-left"}),o.a.createElement("center",null,o.a.createElement("h3",{style:{marginTop:50,marginBottom:30}},"\u66f4\u6539\u5bc6\u7801"))," ",o.a.createElement(Re.a,Object.assign({style:{width:"70%",margin:"auto"}},{labelCol:{xs:{span:24},sm:{span:8}},wrapperCol:{xs:{span:24},sm:{span:16}}},{onSubmit:this.handleSubmit}),o.a.createElement(Re.a.Item,{label:"\u65b0\u5bc6\u7801"},e("password",{rules:[{required:!0,message:"Please input your password!"},{validator:this.validateToNextPassword}]})(o.a.createElement(de.a,{type:"password"}))),o.a.createElement(Re.a.Item,{label:"\u786e\u8ba4\u5bc6\u7801"},e("confirm",{rules:[{required:!0,message:"Please confirm your password!"},{validator:this.compareToFirstPassword}]})(o.a.createElement(de.a,{type:"password",onBlur:this.handleConfirmBlur}))),o.a.createElement(Re.a.Item,{wrapperCol:{xs:{span:24,offset:0},sm:{span:16,offset:8}}},o.a.createElement(w.a,{size:"large",style:{marginRight:20},onClick:this.props.back},"\u53d6\u6d88"),o.a.createElement(w.a,{size:"large",type:"primary",htmlType:"submit"},"\u4fdd\u5b58"))))}}]),t}(o.a.Component),We=Re.a.create({name:"resetPassword"})(_e),He=a(184),Ve=a.n(He),Je=(a(391),function(e){function t(e){var a;return Object(s.a)(this,t),(a=Object(i.a)(this,Object(u.a)(t).call(this,e))).state={pictures:[]},a.onDrop=a.onDrop.bind(Object(pe.a)(Object(pe.a)(a))),a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"onDrop",value:function(e){console.log(e),this.setState({pictures:e}),this.props.setFile(e[0])}},{key:"render",value:function(){var e="";return this.state.pictures.length&&(e="sp-selected-avatar"),o.a.createElement(Ve.a,{className:e,singleImage:!0,buttonClassName:"ant-btn",withPreview:!0,withIcon:!1,withLabel:!1,buttonText:"\u9009\u62e9\u56fe\u7247",fileTypeError:"\u6587\u4ef6\u7c7b\u578b\u4e0d\u652f\u6301",fileSizeError:"\u56fe\u7247\u592a\u5927",onChange:this.onDrop,label:"\u56fe\u7247\u5fc5\u987b\u5c0f\u4e8e2MB",imgExtension:[".jpg",".jpeg",".png",".gif"],maxFileSize:5242880})}}]),t}(o.a.Component)),qe=null,Ge=function(e){function t(){var e,a;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(a=Object(i.a)(this,(e=Object(u.a)(t)).call.apply(e,[this].concat(o)))).state={submitting:!1},a.handleSubmit=function(e){e.preventDefault(),a.props.form.validateFieldsAndScroll(function(e,t){e||(console.log("Received values of form: ",t),console.log(qe),t.avatar=qe,a.setState({submitting:!0}),$(t).then(function(e){b.a.success("\u66f4\u65b0\u6210\u529f\uff01"),a.props.setAccount(e.data)}).catch(function(e){}).then(function(){a.setState({submitting:!1})}))})},a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this.props.form.getFieldDecorator,t=this.props.account;return o.a.createElement("div",{className:"sp-special-tab"},o.a.createElement(w.a,{onClick:this.props.back,style:{position:"fixed",marginTop:5,marginLeft:5,border:"none",fontSize:"large"},icon:"arrow-left"}),o.a.createElement("center",null,o.a.createElement("h3",{style:{marginTop:50,marginBottom:30}},"\u4fee\u6539\u8d44\u6599"))," ",o.a.createElement(Re.a,Object.assign({style:{width:"70%",margin:"auto"}},{labelCol:{xs:{span:24},sm:{span:8}},wrapperCol:{xs:{span:24},sm:{span:16}}},{onSubmit:this.handleSubmit}),o.a.createElement(Re.a.Item,{label:"\u4e0a\u4f20\u5934\u50cf"},e("upload",{valuePropName:"fileList",getValueFromEvent:function(){return qe}})(o.a.createElement(Je,{setFile:function(e){qe=e}}))),o.a.createElement(Re.a.Item,{label:o.a.createElement("span",null,"\u7528\u6237\u540d")},e("name",{rules:[{message:"\u7528\u6237\u540d\u4e0d\u80fd\u4e3a\u7a7a",whitespace:!0}],initialValue:t.name})(o.a.createElement(de.a,null))),o.a.createElement(Re.a.Item,{label:o.a.createElement("span",null,"\u4e2a\u4eba\u7b80\u4ecb")},e("about",{initialValue:t.about})(o.a.createElement(de.a,null))),o.a.createElement(Re.a.Item,{wrapperCol:{xs:{span:24,offset:0},sm:{span:16,offset:8}}},o.a.createElement(w.a,{size:"large",style:{marginRight:20},onClick:this.props.back},"\u53d6\u6d88"),o.a.createElement(w.a,{loading:this.state.submitting,type:"primary",size:"large",htmlType:"submit"},"\u4fdd\u5b58"))))}}]),t}(o.a.Component),Ke=Re.a.create({name:"edit-profile"})(Ge),Xe=(a(392),a(63)),Ye=a(33),$e={margin:"auto",marginTop:20,display:"block"},Qe={height:"calc(100% - 35px)",overflowY:"auto",overflowX:"hidden",width:"100%",position:"fixed",padding:20,paddingTop:10,paddingBottom:30},Ze={display:"inline-block",minWidth:200,maxWidth:350,borderBottom:"1px solid lightgray",textAlign:"left",overflow:"auto",maxHeight:72,padding:5,paddingLeft:10,paddingRight:10,wordBreak:"break-word"};var et=function(e){var t=e.account,a=Object(n.useState)(!1),r=Object(v.a)(a,2),c=r[0],s=r[1];return o.a.createElement("div",{style:Qe},o.a.createElement(L.a,{style:$e,size:128,src:t.avatarSrc,icon:"user"}),o.a.createElement("center",{style:{margin:20,fontSize:"large",fontWeight:"bold"}},t.name),o.a.createElement(Xe.a,{gutter:50,style:{textAlign:"center"}},o.a.createElement(Ye.a,{style:{textAlign:"right"},span:12},"ID: ",t.numId),o.a.createElement(Ye.a,{style:{textAlign:"left"},span:12},"\u79ef\u5206: ",t.credit)),o.a.createElement(Xe.a,{gutter:50,style:{textAlign:"center"}},o.a.createElement(Ye.a,{style:{textAlign:"right"},span:12},o.a.createElement("span",{className:"sp-follow-stats",onClick:e.showFollowings},"\u5173\u6ce8\u4e86: ",t.followingCount)),o.a.createElement(Ye.a,{style:{textAlign:"left"},span:12},o.a.createElement("span",{className:"sp-follow-stats",onClick:e.showFollowers},"\u5173\u6ce8\u8005: ",t.followerCount))),o.a.createElement("br",null),o.a.createElement("center",null,o.a.createElement("div",{style:Ze},t.about),o.a.createElement("div",{style:{marginTop:30}},o.a.createElement(w.a,{type:"primary",icon:"edit",style:{margin:10},size:"large",onClick:e.showEditProfile},"\u4fee\u6539\u8d44\u6599")),o.a.createElement("br",null),o.a.createElement("br",null),o.a.createElement(w.a,{onClick:e.showResetPassword,style:{margin:10}},"\u66f4\u6539\u5bc6\u7801"),o.a.createElement(w.a,{onClick:function(){s(!0),Ue().then(function(e){console.debug("logout success")}).catch(function(e){console.error(e)}).then(function(){s(!1),e.setAccount(null)})},loading:c,type:"danger",style:{margin:10}},"\u767b\u51fa")))};a(393);var tt=function(e){var t=Object(n.useState)(e.showFollowers),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useState)(!0),l=Object(v.a)(s,2),i=l[0],u=l[1],m=Object(n.useState)(!1),d=Object(v.a)(m,2),p=d[0],g=d[1],b=Object(n.useState)([]),E=Object(v.a)(b,2),y=E[0],j=E[1],S=Object(n.useContext)(R),C=Object(n.useContext)(U).account,x=Object(n.useRef)([]);Object(n.useEffect)(function(){if(j([]),N(0),!r)return console.debug("register follow handler"),Q.follow=function(e,t){console.log("update followings");var a=[];a=e?[t].concat(Object(_.a)(x.current)):x.current.filter(function(e){return e.id!==t.id}),j(a)},function(){console.debug("unregister follow handler"),Q.follow=function(){console.debug("following handler isn't mounted")}}},[r]),Object(n.useEffect)(function(){x.current=y},[y]);var N=function(e){var t=k.dbAPI+"/api/v1/";t+=r?"followers":"followings",t+="?offset="+e,e?g(!0):u(!0),f.a.get(t).then(function(e){j(function(t){return t.concat(e.data)})}).catch(function(e){console.error(e)}).then(function(){u(!1),g(!1)})};return o.a.createElement("div",{className:"sp-follow-tab"},o.a.createElement(w.a,{onClick:e.back,style:{position:"fixed",marginTop:1,marginLeft:5,border:"none",fontSize:"large"},icon:"arrow-left"}),o.a.createElement("center",{className:"sp-tab-header"},o.a.createElement(O.a.Group,{className:"sp-toggle-page-site-chat",size:"small",defaultValue:r,buttonStyle:"solid",onChange:function(e){c(e.target.value)}},o.a.createElement(O.a.Button,{value:!1},"\u5173\u6ce8\u4e86 ",C.followingCount),o.a.createElement(O.a.Button,{value:!0},"\u88ab\u5173\u6ce8 ",C.followerCount))),o.a.createElement("div",{className:"sp-tab-body"},i&&o.a.createElement("center",null,o.a.createElement(h.a,{style:{marginTop:10,border:"none",fontSize:"large"},type:"loading"})),y.map(function(e){return o.a.createElement("div",{onClick:function(){return S.selectOtherUser(e)},className:"sp-follow-row",key:e.id},o.a.createElement(L.a,{icon:"user",src:e.avatarSrc}),e.name)}),o.a.createElement("center",{style:{margin:20}},0!==y.length&&(r?y.length<e.followerCount:y.length<e.followingCount)&&o.a.createElement(w.a,{loading:p,type:"primary",onClick:function(){N(y.length)}},"\u52a0\u8f7d\u66f4\u591a..."))))},at={get:function(e,t){window.chrome&&window.chrome.storage?window.chrome.storage.local.get(e,function(a){t(e in a?a[e]:null)}):localStorage.hasOwnProperty(e)?t(JSON.parse(localStorage.getItem(e))):t(null)},set:function(e,t){if(window.chrome&&window.chrome.storage){var a={};a[e]=t,window.chrome.storage.local.set(a)}else{var n=JSON.stringify(t);localStorage.setItem(e,n);var o=document.createEvent("HTMLEvents");o.initEvent("storage",!0,!0),o.eventName="storage",o.key=e,o.newValue=n,window.dispatchEvent(o)}},addEventListener:function(e,t){window.chrome&&window.chrome.storage?window.chrome.storage.onChanged.addListener(function(a,n){e in a&&(console.debug(a[e]),t(a[e].newValue))}):window.addEventListener("storage",function(a){a.key===e&&t(JSON.parse(a.newValue))})}},nt=function(e){function t(e){var a;return Object(s.a)(this,t),(a=Object(i.a)(this,Object(u.a)(t).call(this,e))).loginUser=function(e){a.setState({loading:!0}),Fe(e.userId,e.password).then(function(t){console.debug(t.data);var n=t.data;a.setState({loading:!1}),a.props.setAccount(n),at.set("login",e)}).catch(function(e){console.error(e),a.setState({loading:!1})}).then(function(){})},a.handleSubmit=function(e){e.preventDefault(),a.props.form.validateFields(function(e,t){console.debug("Received values of form: ",t),e||a.loginUser(t)})},a.state={loading:!1,registering:!1},a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"componentDidMount",value:function(){var e=this;at.get("login",function(t){if(t)console.debug("found login in storage"),e.props.form.setFieldsValue({userId:t.userId,password:t.password}),e.context.autoLogin&&(e.loginUser(t),console.debug("auto login"));else{console.debug("no login found in storage, register now");var a=Math.random().toString(36).slice(-8);e.setState({registering:!0}),function(e){var t={password:e};return f.a.post(k.dbAPI+"/api/v1/register",t)}(a).then(function(t){e.setState({registering:!1});var n=t.data;e.props.setAccount(n),at.set("login",{userId:n.numId,password:a}),b.a.success("\u6ce8\u518c\u6210\u529f!")}).catch(function(t){e.setState({registering:!1})}).then(function(){})}e.context.stopAutoLogin()})}},{key:"render",value:function(){if(this.state.registering)return o.a.createElement("div",{className:"sp-special-tab"},o.a.createElement("center",{style:{marginTop:"50%"}},"\u6ce8\u518c\u4e2d..."));var e=this.props.form.getFieldDecorator;return o.a.createElement("div",{className:"sp-special-tab"},o.a.createElement(Re.a,{style:{width:"70%",margin:"auto",marginTop:100},onSubmit:this.handleSubmit,className:"login-form"},o.a.createElement(Re.a.Item,null,e("userId",{rules:[{required:!0,message:"\u8bf7\u8f93\u5165\u7528\u6237ID"}]})(o.a.createElement(de.a,{prefix:o.a.createElement(h.a,{type:"user",style:{color:"rgba(0,0,0,.25)"}}),placeholder:"ID"}))),o.a.createElement(Re.a.Item,null,e("password",{rules:[{required:!0,message:"\u8bf7\u8f93\u5165\u5bc6\u7801"}]})(o.a.createElement(de.a,{prefix:o.a.createElement(h.a,{type:"lock",style:{color:"rgba(0,0,0,.25)"}}),type:"password",placeholder:"\u5bc6\u7801"}))),o.a.createElement(Re.a.Item,null,o.a.createElement(w.a,{type:"primary",htmlType:"submit",className:"login-form-button",style:{marginRight:10},loading:this.state.loading},"\u767b\u5f55"))))}}]),t}(o.a.Component);nt.contextType=U;var ot=Re.a.create({name:"normal_login"})(nt);var rt=function(e){var t=Object(n.useContext)(U),a=t.account,r=t.setAccount,c=Object(n.useState)(!1),s=Object(v.a)(c,2),l=s[0],i=s[1],u=Object(n.useState)(!1),m=Object(v.a)(u,2),d=m[0],f=m[1],p=Object(n.useState)(!1),g=Object(v.a)(p,2),b=g[0],h=g[1],E=Object(n.useState)(!1),y=Object(v.a)(E,2),O=y[0],j=y[1],k=Object(n.useState)(!1),S=Object(v.a)(k,2),C=S[0],x=S[1];Object(n.useEffect)(function(){a&&(x(!0),console.debug("refresh account data"),Be().then(function(e){r(e.data)}).catch(function(e){}).then(function(){x(!1)}))},[]);var N=function(){i(!1),f(!1),h(!1)};return a?o.a.createElement("div",null,C&&o.a.createElement(w.a,{icon:"loading",className:"sp-back-btn"}),l&&o.a.createElement(We,{back:N}),b&&o.a.createElement(tt,{showFollowers:O,followingCount:a.followingCount,followerCount:a.followerCount,back:N}),d&&o.a.createElement(Ke,{account:a,setAccount:r,back:N}),o.a.createElement(et,{account:a,showResetPassword:i,showEditProfile:f,showFollowings:function(){h(!0),j(!1)},showFollowers:function(){h(!0),j(!0)},setAccount:r})):o.a.createElement(ot,{setAccount:r})},ct={margin:"auto",marginTop:20,display:"block"},st={display:"inline-block",minWidth:200,maxWidth:350,borderBottom:"1px solid lightgray",textAlign:"left",overflow:"auto",maxHeight:72,padding:5,paddingLeft:10,paddingRight:10,wordBreak:"break-word"};var lt=function(e){var t=e.directMessage,a=e.loading,n=e.loaded,r=e.user,c=e.following,s=e.followerCount,l=e.followUser;return o.a.createElement("div",null,o.a.createElement(L.a,{style:ct,size:128,src:r.avatarSrc,icon:"user"}),o.a.createElement("center",{style:{margin:20,fontSize:"large",fontWeight:"bold"}},r.name,a&&o.a.createElement(h.a,{style:{display:"block",marginTop:10,border:"none"},type:"loading"})),n&&o.a.createElement("span",null,o.a.createElement(Xe.a,{gutter:50,style:{textAlign:"center"}},o.a.createElement(Ye.a,{style:{textAlign:"right"},span:12},"ID: ",r.numId),o.a.createElement(Ye.a,{style:{textAlign:"left"},span:12},"\u5173\u6ce8\u8005: ",s)),o.a.createElement("br",null),o.a.createElement("center",null,o.a.createElement("div",{style:st},r.about),o.a.createElement("div",{style:{marginTop:30}},c&&o.a.createElement(w.a,{icon:"user-delete",style:{margin:10},size:"large",onClick:function(){l(!1)}},"\u53d6\u6d88\u5173\u6ce8"),!c&&o.a.createElement(w.a,{type:"primary",icon:"user-add",style:{margin:10},size:"large",onClick:function(){l(!0)}},"\u5173\u6ce8"),o.a.createElement(w.a,{onClick:function(){t(r)},icon:"mail",style:{margin:10},size:"large"},"\u79c1\u4fe1")))))};var it=function(e){if(!e.data)return o.a.createElement("span",null);var t={avatarSrc:e.data.avatarSrc,name:e.data.name,id:e.data.userId||e.data.id};return o.a.createElement("div",{className:"sp-special-tab"},o.a.createElement(w.a,{onClick:function(){return e.selectOtherUser()},className:"sp-back-btn",icon:"arrow-left"}),o.a.createElement(ee,{user:t},o.a.createElement(lt,{directMessage:e.directMessage})))},ut=a(91),mt=(a(394),a(395),function(e){var t={offset:e};return f.a.get("".concat(k.dbAPI,"/api/v1/messages"),{params:t})}),dt=function(e,t,a){var n={userId:e,content:t,offset:a};return f.a.post("".concat(k.dbAPI,"/api/v1/message"),n)},ft={height:"calc(100% - 107px)",overflow:"auto",width:"100%",position:"fixed",background:"#f6f9fc",padding:10,paddingBottom:50},pt=150;var gt=function(e){var t=Object(n.useContext)(U).account,a=Object(n.useContext)(R),r=e.conversation.messages,c=e.conversation.user,s=e.offset,l=Object(n.useState)(!1),i=Object(v.a)(l,2),u=i[0],m=i[1],d=Object(n.useRef)(),f=null,p=r.map(function(e){e.text=e.content,e.self?(e.name=t.name,e.avatarSrc=t.avatarSrc,e.userId=t.id):(e.name=c.name,e.avatarSrc=c.avatarSrc,e.userId=c.id);var a=!1;return f&&f.userId===e.userId&&(a=!0),f=e,o.a.createElement(se,{key:e.id,data:e,mergeAbove:a})});return Object(n.useEffect)(function(){var e=d.current;e.scrollTop=e.scrollHeight},[]),Object(n.useEffect)(function(){if(console.debug("auto scroll down"),r&&r.length){var e=50;"sticker"===r[r.length-1].type&&(e=500),function(e){e=e||100;var t=d.current;t.scrollHeight-t.scrollTop-t.offsetHeight<pt&&setTimeout(function(){t.scrollTop=t.scrollHeight},e)}(e)}},[r]),o.a.createElement("div",{className:"sp-inbox-conversation"},o.a.createElement(w.a,{onClick:e.back,className:"sp-back-btn",icon:"arrow-left"}),o.a.createElement("div",{className:"sp-tab-header"},o.a.createElement("center",null,o.a.createElement("span",null,"\u4e0e",o.a.createElement("span",{className:"sp-conversation-username",onClick:function(){return a.selectOtherUser(c)}},c.name),"\u7684\u5bf9\u8bdd"))),o.a.createElement("div",{ref:d,style:ft},p),o.a.createElement("div",{className:"sp-chat-bottom"},o.a.createElement(we,{sending:u,send:function(t){return m(!0),dt(c.id,t,s).then(function(t){e.mergeAndSaveNewConversations(t.data)}).catch(function(e){console.error(e)}).then(function(){m(!1)}),!0}})))};var bt=function(e){var t=e.user,a=e.setUser,r=Object(n.useContext)(U).account,c="inbox-";r&&(c+=r.id);var s=Object(n.useRef)(),l=Object(n.useState)({}),i=Object(v.a)(l,2),u=i[0],m=i[1],d=Object(n.useState)(!1),f=Object(v.a)(d,2),p=f[0],b=f[1],E=Object(n.useState)(!1),y=Object(v.a)(E,2),w=y[0],j=y[1],k=null;function S(e){at.get(c,function(t){t=t||{},Object.keys(e).forEach(function(a){var n;a in t?((n=t[a].messages).push.apply(n,Object(_.a)(e[a].messages)),t[a].user=e[a].user):t[a]=e[a]}),at.set(c,t)})}function C(e){var t=0;return Object.values(e).forEach(function(e){e.messages.length&&(e.lastMsg=e.messages[e.messages.length-1],t=Math.max(t,e.lastMsg.id))}),t}t&&(t.id in u?k=u[t.id]:(k={user:t,messages:[]},m(Object(K.a)({},u,Object(ut.a)({},t.id,k))))),Object(n.useEffect)(function(){},[]),Object(n.useEffect)(function(){r?s.current||(console.debug("[inbox] logged in, load from storage"),at.get(c,function(e){var t;m(e=e||{}),console.debug("[inbox] loaded from storage, fetch from server"),t=C(e),j(!0),mt(t).then(function(e){S(e.data)}).catch(function(e){console.error(e)}).then(function(){j(!1)})}),console.debug("register inbox storage listener"),at.addEventListener(c,function(e){console.debug("[inbox] storage updated"),m(e)})):(console.debug("[inbox] logged out"),a(null),m({})),s.current=r},[r]);var x=Object.keys(u).map(function(e){var t=u[e];return t.messages.length?(t.lastMsg=t.messages[t.messages.length-1],t.time=g.a.utc(t.lastMsg.created)):t.time=g.a.utc(),t});x.sort(function(e,t){return t.time-e.time});var N=x.map(function(e){var t=e.user;return o.a.createElement("div",{onClick:function(){a(t)},key:t.id,className:"sp-inbox-row"},o.a.createElement(L.a,{icon:"user",src:t.avatarSrc}),o.a.createElement("span",{className:"sp-row-right"},o.a.createElement("div",null,t.name,e.lastMsg&&o.a.createElement("span",{className:"sp-message-time"},e.time.fromNow())),e.lastMsg&&o.a.createElement("div",{className:"sp-message-content"},e.lastMsg.content)))});return 0===x.length&&(N=o.a.createElement("center",{style:{margin:20}},"\u6ca1\u6709\u6d88\u606f")),r?o.a.createElement("div",{className:"sp-inbox-tab"},k&&!p&&o.a.createElement(gt,{back:function(){a(null)},offset:C(u),conversation:k,mergeAndSaveNewConversations:S}),!k&&o.a.createElement("div",null,o.a.createElement("center",{className:"sp-tab-header"},w&&o.a.createElement(h.a,{style:{margin:3,position:"absolute",left:10,border:"none",fontSize:"large"},type:"loading"}),o.a.createElement(O.a.Group,{size:"small",defaultValue:p,buttonStyle:"solid",onChange:function(e){b(e.target.value)}},o.a.createElement(O.a.Button,{value:!1},"\u79c1\u4fe1"),o.a.createElement(O.a.Button,{value:!0},"\u6d88\u606f"))),o.a.createElement("div",{className:"sp-tab-body",style:{paddingBottom:70}},!p&&N,p&&o.a.createElement("center",{style:{margin:20}},"\u6ca1\u6709\u6d88\u606f")))):o.a.createElement("div",{className:"sp-inbox-tab"},o.a.createElement("center",{className:"sp-tab-header"},"\u5c1a\u672a\u767b\u5f55"))},ht=a(403),vt=function(){return f.a.get("".concat(k.dbAPI,"/api/v1/latest_danmus"))};var Et=function(e){var t=Object(n.useState)(!0),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useState)([]),l=Object(v.a)(s,2),i=l[0],u=l[1];return Object(n.useEffect)(function(){vt().then(function(e){u(e.data)}).catch(function(e){}).then(function(){c(!1)})},[]),r?o.a.createElement("center",null,o.a.createElement(h.a,{type:"loading"})):i.map(function(e){return o.a.createElement("div",{className:"sp-home-comment",key:e.id},o.a.createElement("a",{className:"sp-comment-url",target:"_blank",rel:"noopener noreferrer",href:e.url},e.url),o.a.createElement("div",{className:"sp-comment-body"},o.a.createElement(re,{className:"sp-pointer-cursor",size:"small",user:e.user}),o.a.createElement("span",{className:"sp-comment-message"},e.content)))})},yt=(a(396),function(){return f.a.get("".concat(k.dbAPI,"/api/v1/latest_comments"))});var wt=function(e){var t=Object(n.useState)(!0),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useState)([]),l=Object(v.a)(s,2),i=l[0],u=l[1];return Object(n.useEffect)(function(){yt().then(function(e){u(e.data)}).catch(function(e){}).then(function(){c(!1)})},[]),r?o.a.createElement("center",null,o.a.createElement(h.a,{type:"loading"})):i.map(function(e){return o.a.createElement("div",{className:"sp-home-comment",key:e.id},o.a.createElement("a",{className:"sp-comment-url",target:"_blank",rel:"noopener noreferrer",href:e.url},e.url),o.a.createElement("div",{className:"sp-comment-body"},o.a.createElement(re,{className:"sp-pointer-cursor",size:"small",user:e.user}),o.a.createElement("span",{className:"sp-comment-message"},e.content)))})};a(397);var Ot=function(e){var t=Object(n.useState)(!0),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useState)([]),l=Object(v.a)(s,2),i=l[0],u=l[1];return Object(n.useEffect)(function(){Y().then(function(e){u(e.data)}).catch(function(e){}).then(function(){c(!1)})},[]),r?o.a.createElement("center",null,o.a.createElement(h.a,{type:"loading"})):i.map(function(e){return o.a.createElement("div",{className:"sp-home-users",key:e.id},o.a.createElement("div",null,o.a.createElement(re,{className:"sp-pointer-cursor",user:e}),o.a.createElement("span",{className:"sp-username"},e.name)))})},jt=function(){return f.a.get("".concat(k.socketAPI,"/api/popular_rooms"))};var kt=function(e){var t=Object(n.useState)(!0),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useState)([]),l=Object(v.a)(s,2),i=l[0],u=l[1],m=Object(n.useContext)(R);return Object(n.useEffect)(function(){jt().then(function(e){u(e.data)}).catch(function(e){}).then(function(){c(!1)})},[]),r?o.a.createElement("center",null,o.a.createElement(h.a,{type:"loading"})):i.map(function(e){var t=e.roomId;return"lobby"===t?o.a.createElement("div",{className:"sp-home-comment",key:t},o.a.createElement("div",{className:"sp-comment-url",onClick:function(){m.changeTab("chat"),z.togglePageSite("lobby")}},"\u804a\u5929\u5927\u5385 (",e.userCount,")")):o.a.createElement("div",{className:"sp-home-comment",key:t},o.a.createElement("a",{className:"sp-comment-url",rel:"noopener noreferrer",target:"_blank",href:e.url},e.title," (",e.userCount,")"))})},St=ht.a.Panel;var Ct=function(e){return o.a.createElement(ht.a,{bordered:!1,className:"sp-special-tab",defaultActiveKey:["hot-chatrooms"],onChange:function(e){}},o.a.createElement(St,{header:"\u70ed\u95e8\u804a\u5929\u5ba4",key:"hot-chatrooms"},o.a.createElement(kt,null)),o.a.createElement(St,{header:"\u6700\u65b0\u7f51\u9875\u7559\u8a00",key:"latest-comments"},o.a.createElement(wt,null)),o.a.createElement(St,{header:"\u6700\u65b0\u89c6\u9891\u5f39\u5e55",key:"latest-danmus"},o.a.createElement(Et,null)),o.a.createElement(St,{header:"\u65b0\u7528\u6237",key:"new-users"},o.a.createElement(Ot,null)))},xt=E.a.TabPane;var Nt=function(e){console.log("render tab");var t=Object(n.useState)(e.tab),a=Object(v.a)(t,2),r=a[0],c=a[1],s=Object(n.useState)(),l=Object(v.a)(s,2),i=l[0],u=l[1],m=Object(n.useState)(),d=Object(v.a)(m,2),f=d[0],p=d[1];return o.a.createElement(R.Provider,{value:{selectOtherUser:u,changeTab:c,directMessage:function(e){u(null),c("inbox"),p(e)}}},o.a.createElement("div",{className:"card-container"},o.a.createElement(E.a,{onChange:function(e){"minimize"!=e?(c(e),u(null)):window.parent.postMessage("minimize","*")},activeKey:r,type:"card"},o.a.createElement(xt,{tab:o.a.createElement(y.a,{title:"\u53d1\u73b0",placement:"bottom"},o.a.createElement(h.a,{type:"home"})),key:"home"},o.a.createElement(Ct,null)),o.a.createElement(xt,{tab:o.a.createElement(y.a,{title:"\u5b9e\u65f6\u804a\u5929",placement:"bottom"},o.a.createElement(h.a,{type:"message"})),key:"chat",forceRender:!0},o.a.createElement(Se,null)),o.a.createElement(xt,{tab:o.a.createElement(y.a,{title:"\u7559\u8a00\u677f",placement:"bottom"},o.a.createElement(h.a,{type:"form"})),key:"comment"},o.a.createElement(Le,null)),o.a.createElement(xt,{tab:o.a.createElement(y.a,{title:"\u6536\u4ef6\u7bb1",placement:"bottom"},o.a.createElement(h.a,{type:"mail"})),key:"inbox"},o.a.createElement(bt,{user:f,setUser:p})),o.a.createElement(xt,{tab:o.a.createElement(y.a,{title:"\u4e2a\u4eba\u4fe1\u606f",placement:"bottom"},o.a.createElement(h.a,{type:"user"})),key:"account"},o.a.createElement(rt,null)),o.a.createElement(xt,{tab:o.a.createElement(y.a,{title:"\u9690\u85cf\u804a\u5929\u76d2",placement:"bottom"},o.a.createElement(h.a,{type:"close"})),key:"minimize"},o.a.createElement("span",null,"shoud not see this!")))),o.a.createElement(it,{data:i,selectOtherUser:u}))};a(398);var It=function(e){function t(e){var a;return Object(s.a)(this,t),(a=Object(i.a)(this,Object(u.a)(t).call(this,e))).setAccount=function(e){console.debug("set account"),at.set("account",e)},a.stopAutoLogin=function(){a.setState({autoLogin:!1})},a.state={account:null,loadingFromStorage:!0,autoLogin:!1},(window.navigator.userLanguage||window.navigator.language).indexOf("zh")>-1&&g.a.locale("zh-cn"),b.a.config({top:80,duration:2,maxCount:3}),a}return Object(m.a)(t,e),Object(l.a)(t,[{key:"componentDidMount",value:function(){var e=this;f.a.interceptors.response.use(function(e){return e},function(t){var a="\u51fa\u9519\u4e86";return t.response&&401===t.response.status&&(e.setAccount(null),a="\u8bf7\u91cd\u65b0\u767b\u5f55"),t.response&&t.response.data&&t.response.data.error&&(a=t.response.data.error),b.a.error(a),Promise.reject(t)}),console.log("get account from storage, register account change listener"),at.get("account",function(t){t?(console.debug("found account in storage"),console.debug(t),e.setState({account:t})):(e.setState({autoLogin:!0}),console.debug("no account found in storage")),e.setState({loadingFromStorage:!1})}),at.addEventListener("account",function(t){e.setState({account:t})}),P.onConnected=function(){b.a.success("\u8fde\u63a5\u6210\u529f\uff01",2)},P.onDisconnected=function(){b.a.warn("\u8fde\u63a5\u5df2\u65ad\u5f00",2)},window.addEventListener("message",function(e){if(e&&e.data&&e.data.locationUpdate){var t=e.data.url,a=e.data.title;C()===t&&I()===a||(S=t,N=a,z.updatePageInfo({url:t,title:a}))}},!1)}},{key:"componentDidUpdate",value:function(e,t,a){var n=!t.account&&this.state.account,o=t.account&&!this.state.account;n&&(console.debug("logged in"),f.a.defaults.headers.common.token=this.state.account.token,z.connect(this.state.account,!0)),o&&(console.debug("logged out"),f.a.defaults.headers.common.token=null,z.disconnect())}},{key:"render",value:function(){if(this.state.loadingFromStorage)return o.a.createElement("center",null,o.a.createElement(h.a,{style:{marginTop:"50%"},type:"loading"}));var e="home";return this.state.account||(e="account"),o.a.createElement(U.Provider,{value:{account:this.state.account,setAccount:this.setAccount,autoLogin:this.state.autoLogin,stopAutoLogin:this.stopAutoLogin}},o.a.createElement(Nt,{tab:e}))}}]),t}(o.a.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));c.a.render(o.a.createElement(It,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[188,1,2]]]);
//# sourceMappingURL=main.0e932fe8.chunk.js.map